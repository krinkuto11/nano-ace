# Multi-stage build for Acestream 3.2.11 (Ubuntu 22.04, Python 3.10) with distroless
# Stage 1: Download and extract Acestream
FROM python:3.10-bookworm AS builder

# Install dependencies needed for downloading and extracting
RUN apt-get update && apt-get install -y \
    wget \
    tar \
    && rm -rf /var/lib/apt/lists/*

# Create directory for Acestream
RUN mkdir -p /acestream

# Download and extract Acestream
RUN wget -O /tmp/acestream.tar.gz https://download.acestream.media/linux/acestream_3.2.11_ubuntu_22.04_x86_64_py3.10.tar.gz && \
    tar -xzf /tmp/acestream.tar.gz -C /acestream && \
    rm /tmp/acestream.tar.gz

# Install Python dependencies if requirements.txt exists
WORKDIR /acestream
RUN if [ -f requirements.txt ]; then pip install --no-cache-dir -r requirements.txt; fi

# Create cache directory
RUN mkdir -p /acestream/.ACEStream

# Stage 2: Create minimal distroless runtime image
# Using cc-debian12 as it includes necessary C libraries for Python runtime
FROM gcr.io/distroless/cc-debian12:latest

# Copy Acestream installation from builder (includes bundled Python runtime)
COPY --from=builder /acestream /acestream

# Copy complete Python runtime and libraries from builder
COPY --from=builder /usr/local/lib/python3.10 /usr/local/lib/python3.10
COPY --from=builder /usr/local/bin/python3.10 /usr/local/bin/python3.10
COPY --from=builder /usr/local/bin/python3 /usr/local/bin/python3
# Copy Python shared library from builder
COPY --from=builder /usr/local/lib/libpython3.10.so.1.0 /usr/local/lib/libpython3.10.so.1.0

# Copy system libraries needed by Python modules and acestream
COPY --from=builder /lib/x86_64-linux-gnu /lib/x86_64-linux-gnu
COPY --from=builder /usr/lib/x86_64-linux-gnu /usr/lib/x86_64-linux-gnu

# Set working directory
WORKDIR /acestream

# Expose ports (6878: API HTTP, 8621: P2P BitTorrent)
EXPOSE 6878 8621

# Set library path to include acestream lib directory and system libraries
ENV LD_LIBRARY_PATH=/acestream/lib:/usr/local/lib

# Run acestream engine directly with default arguments
# Users can override CMD when running: docker run ... image ["/acestream/acestreamengine", "arg1", "arg2"]
CMD ["/acestream/acestreamengine", "--client-console", "--bind-all"]
