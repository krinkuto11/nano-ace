# Multi-stage build for Acestream 3.1.74 (Ubuntu 18.04, Python 2.7) with distroless
# Stage 1: Download and extract Acestream
FROM python:2.7-slim-buster AS builder

# Update apt sources to use Debian archive (Buster is EOL)
RUN sed -i 's|http://deb.debian.org/debian|http://archive.debian.org/debian|g' /etc/apt/sources.list && \
    sed -i 's|http://security.debian.org/debian-security|http://archive.debian.org/debian-security|g' /etc/apt/sources.list && \
    sed -i '/buster-updates/d' /etc/apt/sources.list

# Install dependencies needed for downloading and extracting
RUN apt-get update && apt-get install -y \
    wget \
    tar \
    && rm -rf /var/lib/apt/lists/*

# Create directory for Acestream
RUN mkdir -p /acestream

# Download and extract Acestream
RUN wget -O /tmp/acestream.tar.gz https://download.acestream.media/linux/acestream_3.1.74_ubuntu_18.04_x86_64.tar.gz && \
    tar -xzf /tmp/acestream.tar.gz -C /acestream && \
    rm /tmp/acestream.tar.gz

# Install Python dependencies if requirements.txt exists
WORKDIR /acestream
RUN if [ -f requirements.txt ]; then pip install --no-cache-dir -r requirements.txt; fi

# Create cache directory
RUN mkdir -p /acestream/.ACEStream

# Stage 2: Create minimal distroless runtime image
# Using cc-debian12 as it includes necessary C libraries for Python runtime
FROM gcr.io/distroless/cc-debian12:latest

# Copy Acestream installation from builder (includes bundled Python runtime)
COPY --from=builder /acestream /acestream

# Copy complete Python runtime and libraries from builder
COPY --from=builder /usr/local/lib/python2.7 /usr/local/lib/python2.7
COPY --from=builder /usr/local/bin/python2.7 /usr/local/bin/python2.7
COPY --from=builder /usr/local/bin/python2 /usr/local/bin/python2
COPY --from=builder /usr/local/bin/python /usr/local/bin/python
# Copy Python shared library from builder
COPY --from=builder /usr/local/lib/libpython2.7.so.1.0 /usr/local/lib/libpython2.7.so.1.0

# Copy ONLY the minimal required system libraries
COPY --from=builder /lib/x86_64-linux-gnu/libm.so.6 /lib/x86_64-linux-gnu/
COPY --from=builder /lib/x86_64-linux-gnu/libc.so.6 /lib/x86_64-linux-gnu/
COPY --from=builder /lib64/ld-linux-x86-64.so.2 /lib64/
COPY --from=builder /lib/x86_64-linux-gnu/libz.so.1 /lib/x86_64-linux-gnu/
COPY --from=builder /usr/lib/x86_64-linux-gnu/libsqlite3.so.0 /usr/lib/x86_64-linux-gnu/
COPY --from=builder /usr/lib/x86_64-linux-gnu/libffi.so.6 /usr/lib/x86_64-linux-gnu/

# Set working directory
WORKDIR /acestream

# Expose ports (6878: API HTTP, 8621: P2P BitTorrent)
EXPOSE 6878 8621

# Set library path to include acestream lib directory and system libraries
ENV LD_LIBRARY_PATH=/acestream/lib:/usr/local/lib

# Run acestream engine directly with default arguments
# Users can override CMD when running: docker run ... image ["/acestream/acestreamengine", "arg1", "arg2"]
CMD ["/acestream/acestreamengine", "--client-console", "--bind-all"]
